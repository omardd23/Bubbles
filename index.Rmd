---
title: "Caso"
author: "Roberto Ruz Campos"
date: "30/11/2019"
output:
  html_document:
    df_print: paged
---

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(rvest)
```

Se importa la tabla "Compustat Global Daily" con los tipos de datos correctos.
```{r}
global_daily <- read_csv("Compustat_Global_Daily.csv",
  col_types = cols(
    sedol = col_character(), 
    datadate = col_date(format = "%Y%m%d") 
  )
)
```

Extraemos de Wikipedia la tabla de códigos GICS con sus respectivos nombres.

```{r message=FALSE, warning=FALSE}
gics_table <- read_html("https://en.wikipedia.org/wiki/Global_Industry_Classification_Standard") %>%
  html_node("table") %>%
  html_table(fill = TRUE) %>%
  as_tibble(.name_repair = "universal") %>%
  distinct(gsector = Sector...1, gics_name = Sector...2)
```


Se le añaden los nombres de los sectores a la tabla original
```{r}
global_daily <- left_join(global_daily, gics_table, by = "gsector")
```

```{r}
global_daily <- global_daily %>% 
  arrange(datadate) %>% 
  mutate(id = row_number())
```

Tipo de variable de cada columna
```{r}
global_daily %>%
  summarise_all(class) %>%
  pivot_longer(everything(), names_to = "column", values_to = "type")
```


## Exploratory analysis

Podemos notar que tenemos una tablas con `r dim(global_daily)[1]` filas y 
`r dim(global_daily)[2]` columnas.
  
¿Cuántos valores distintos hay por cada columna? y ¿ Cuántos `NA` hay en cada columna?
```{r}
global_daily %>% 
  summarise_all(n_distinct)

global_daily %>%
  summarise_all(~ sum(is.na(.x)))

```

Deberá llamarnos la atención que no hay correspondencia uno a uno entre `conm` y `gvkey`,
por lo que suponemos que un `conm` tiene 2 `gvkey`, pues hay 292 `gvkey` y 291 `conm` Veamos...

```{r}
global_daily %>% 
  select(gvkey, conm) %>% 
  group_by(conm) %>% 
  summarise(distinct_key = n_distinct(gvkey)) %>% 
  filter(distinct_key > 1)
```
## Caso Nacional Financiera 

Efectivamente es "NACIONAL FINANCIERA SNC" quien tiene asociados dos `gvkey` distintos.
Veamos cuales son
```{r}
global_daily %>% 
  filter(conm == "NACIONAL FINANCIERA SNC") %>% 
  group_by(gvkey) %>% 
  summarise(n = n(), prim_ap = min(datadate), ult_ap = max(datadate))
```
Lo que nos hace suponer que desde agosto de 2018 coexisten los dos `gvkey`, por lo que
tendría que haber más de un registro por día
```{r}
global_daily %>% 
  filter(conm == "NACIONAL FINANCIERA SNC") %>% 
  group_by(datadate) %>% 
  summarise(n = n()) %>% 
  filter(datadate >= "2013-08-07", datadate <= "2019-11-26")
```

Efectivamente cada día hay dos registros cada uno con diferente `gvkey`. Tomemos de muestra
al 2019.
```{r}

global_daily %>% 
  mutate(year = year(datadate)) %>% 
  filter(conm == "NACIONAL FINANCIERA SNC", year == 2019) %>% 
  select(gvkey, datadate, conm, ) %>% 
  arrange(datadate)

```

**¡¿Qué hacemos?!** 
¿Quitamos los 1,645 registros de gvkey 315924?

***

Siguiendo con el análisis... Vemos que hay cinco diferentes monedas `curcdd`y cinco diferentes
mercados `exchg`. 
Donde el código 208 corresponde a la bolsa mexicana y que tiene 708,038 que coinciden con 
la suma de los registros con las monedas MXP, MXN y los NA.
Así que todos los registros que no sean `exchg = 208 ` son candidatos a eliminación

```{r}
global_daily %>% 
  count(curcdd) 

global_daily %>% 
  count(exchg)

global_daily %>%
  count(curcdd) %>%
  filter(curcdd == "MXN" | curcdd == "MXP" | is.na(curcdd)) %>%
  summarise(sum(n)) %>%
  pull()
```
***

observaciones de cada compañía
```{r}
global_daily %>% 
  count(conm) %>% 
  arrange(n)
```





```{r}
global_daily %>% 
  count(conm) %>% 
  arrange(n) %>% 
  filter(n == 1)

global_daily %>% 
  select(conm, datadate) %>% 
  group_by(conm) %>%
  mutate(n = n()) %>% 
  filter(n == 1)
```



¿Cuántas empresas hay por sector?
```{r}
global_daily %>% 
  group_by(gics_name) %>% 
  summarise(n = n_distinct(conm))
```

```{r}
global_daily %>% 
  filter(conm == "WAL MART DE MEXICO SA") %>% 
  mutate(year = year(datadate)) %>% 
  group_by(year) %>% 
  summarise(n = n())

global_daily %>% 
  filter(conm == "WAL MART DE MEXICO SA") %>%  
  mutate(year = year(datadate)) %>% 
  filter(year == 1993) %>% 
  arrange(datadate) %>% 
  select(gvkey, datadate, conm, ajexdi, cshoc, prccd, prcstd, isin)
```

***

```{r}
# Se eliminan los registros que no correspondan al código de mercado de la BMV, así
# como el registro restante en USD 
global_daily1 <- global_daily %>% 
  filter(exchg == 208, !curcdd %in% "USD")

# Solo quedan registros en MXP, MXN y NA
global_daily1 %>% 
  count(curcdd)

# Se procede a ver cuales son los registros que tiene NA es moneda
curcdd_na <- global_daily1 %>% 
  filter(is.na(curcdd)) %>% 
  arrange(datadate) %>% 
  mutate(dummy = paste(as.character(datadate), conm)) %>% 
  pull(dummy)

rep_curr <- global_daily1 %>% 
  mutate(dummy = paste(as.character(datadate), conm)) %>% 
  filter(dummy %in% curcdd_na) %>% 
  arrange(datadate) %>% 
  filter(curcdd == "MXN") %>% 
  pull(dummy)

filter_out <-  global_daily1 %>% 
  mutate(dummy = paste(as.character(datadate), conm)) %>% 
  filter(dummy %in% rep_curr & is.na(curcdd)) %>% 
  arrange(datadate) %>% 
  pull(id)

global_daily1 <- global_daily1 %>% 
  filter(!id %in% filter_out)

global_daily1 %>% 
  count(curcdd)
```

```{r}
global_daily1 %>% 
  filter(is.na(curcdd)) 
```

```{r}
global_daily1 %>% 
  mutate(year = year(datadate)) %>% 
  filter(conm == "CIBANCO SA", year == 2018)
```

***
Todas las empresas que tienen alguna fecha duplicada

```{r}
filt_dup <- global_daily1 %>% 
  group_by(datadate, conm) %>% 
  count(datadate) %>% 
  filter(n > 1)  %>% 
  mutate(dummy = paste(as.character(datadate),conm)) %>% 
  pull(dummy)

dups <- global_daily1 %>%
  mutate(dummy = paste(as.character(datadate), conm)) %>%
  filter(dummy %in% filt_dup) %>%
  arrange(datadate) %>%
  select(-dummy)

dups 
```
¿Cuántas empresas diferentes tienen duplicados?

```{r}
length(unique(dups$conm))
```


