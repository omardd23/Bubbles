---
title: "Caso"
author: "Roberto Ruz Campos"
date: "30/11/2019"
output:
  html_document:
    df_print: paged
---

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(rvest)
```

Se importa la tabla "Compustat Global Daily" con los tipos de datos correctos.
```{r}
global_daily <- read_csv("Compustat_Global_Daily.csv",
  col_types = cols(
    sedol = col_character(), 
    datadate = col_date(format = "%Y%m%d") 
  )
)
```

Extraemos de Wikipedia la tabla de códigos GICS con sus respectivos nombres.

```{r message=FALSE, warning=FALSE}
gics_table <- read_html("https://en.wikipedia.org/wiki/Global_Industry_Classification_Standard") %>%
  html_node("table") %>%
  html_table(fill = TRUE) %>%
  as_tibble(.name_repair = "universal") %>%
  distinct(gsector = Sector...1, gics_name = Sector...2)
```

Se le añaden los nombres de los sectores a la tabla original
```{r}
global_daily <- left_join(global_daily, gics_table, by = "gsector")
```

Tipo de variable de cada columna
```{r}
global_daily %>%
  summarise_all(class) %>%
  pivot_longer(everything(), names_to = "column", values_to = "type")
```


## Exploratory analysis

Podemos notar que tenemos una tablas con `r dim(global_daily)[1]` filas y 
`r dim(global_daily)[2]` columnas.
  
¿Cuántos valores distintos hay por cada columna?
```{r}
global_daily %>% 
  summarise_all(n_distinct)
```

Deberán llamarnos la atención que no hay correspondencia uno a uno entre conm y gvkey,
por lo que suponemos que un conm tiene 2 gvkey... Veamos

```{r}
global_daily %>% 
  select(gvkey, conm) %>% 
  group_by(conm) %>% 
  summarise(distinct_key = n_distinct(gvkey))
```
## Caso Nacional Financiera 

Efectivamente es "NACIONAL FINANCIERA SNC" quien tiene asociados dos gvkey distintos.
Veamos cuales son
```{r}
global_daily %>% 
  filter(conm == "NACIONAL FINANCIERA SNC") %>% 
  group_by(gvkey) %>% 
  summarise(n = n(), prim_ap = min(datadate), ult_ap = max(datadate))
```
Lo que nos hace suponer que desde agosto de 2018 coexisten los dos gvkey, por lo que
tendría que haber más de un registro por día
```{r}
global_daily %>% 
  filter(conm == "NACIONAL FINANCIERA SNC") %>% 
  group_by(datadate) %>% 
  summarise(n = n()) %>% 
  filter(datadate >= "2013-08-07", datadate <= "2019-11-26")
```

Efectivamente cada día hay dos registros cada uno con diferente gvkey. Tomemos de muestra
al 2019.
```{r}

global_daily %>% 
  mutate(year = year(datadate)) %>% 
  filter(conm == "NACIONAL FINANCIERA SNC", year == 2019) %>% 
  arrange(datadate)

```

**¡¿Qué hacemos?!** 
¿Quitamos los 1,645 registros de gvkey 315924?

***

```{r}
global_daily %>% 
  count(curcdd) 
```
observaciones de cada compañía
```{r}
global_daily %>% 
  count(conm) %>% 
  arrange(n)

global_daily %>% 
  count(conm) %>% 
  arrange(desc(n))
```




```{r}
global_daily %>% 
  filter(is.na(qunit)) %>% 
  count(conm)
```


```{r}
global_daily %>% 
  count(gsector)
```
industries
```{r}
global_daily %>%
  group_by(conm) %>% 
  count(sic) %>% 
  arrange(sic)

global_daily %>% 
  count(sic)
```




```{r}
global_daily %>% 
  count(conm) %>% 
  arrange(n) %>% 
  filter(n == 1)

global_daily %>% 
  select(conm, datadate) %>% 
  group_by(conm) %>%
  mutate(n = n()) %>% 
  filter(n == 1)
```

```{r}
global_daily %>% 
  select(datadate) %>%
  distinct(datadate) %>% 
  arrange(datadate)
```
```{r}
global_daily %>% 
  filter(conm == "WAL MART DE MEXICO SA") %>% 
  select(conm, datadate, cshoc, cshtrd, prccd, prcstd, gsector) %>% 
  mutate(year = year(datadate)) %>% 
  group_by(year) %>% 
  summarise(n = n())

global_daily %>% 
  filter(conm == "WAL MART DE MEXICO SA") %>% 
  select(conm, datadate, cshoc, cshtrd, prccd, prcstd, gsector) %>% 
  arrange(datadate)

global_daily %>% 
  filter(conm == "WAL MART DE MEXICO SA") %>%  
  mutate(year = year(datadate)) %>% 
  filter(year == 1993) %>% 
  arrange(datadate) %>% 
  filter(curcdd == "MXN") 
```
```{r}
global_daily %>% 
  count(exchg)
```

```{r}
global_daily %>% 
  mutate(year = year(datadate)) %>% 
  filter(conm == "CEMEX SAB DE CV", year == 2019) %>% 
  arrange(datadate)

global_daily %>% 
  mutate(year = year(datadate)) %>% 
  filter(conm == "CEMEX SAB DE CV", year == 2019) %>% 
  count(isin)

```




